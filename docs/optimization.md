# 优化建议

## 性能优化

### 1. 推理引擎

#### KV Cache 复用
- **当前**：会话切换时重建整个上下文
- **优化**：使用 `llama_memory_seq_*` API 管理多序列 KV，避免重建
- **收益**：会话切换耗时从 ~100ms 降至 <1ms

#### 批处理 Prefill
- **当前**：单序列 batch
- **优化**：多会话请求并发 prefill（需 `n_seq_max > 1`）
- **收益**：吞吐提升 2-3x

#### GPU 层数自适应
- **当前**：手动设置或全 CPU
- **优化**：探测 VRAM 可用量，自动设置 `gpu_layers`
- **收益**：CPU/GPU 混合推理，平衡延迟与资源

### 2. 会话管理

#### 增量历史加载
- **当前**：每次对话全量渲染历史
- **优化**：缓存已 tokenize 的前缀，仅追加新消息
- **收益**：长会话下降低 prefill 耗时

#### 历史截断策略
- **当前**：无自动截断
- **优化**：超过 `n_ctx * 0.8` 时自动截断早期消息或摘要压缩
- **收益**：避免上下文溢出

### 3. 工具系统

#### 并发工具调用
- **当前**：串行执行内联工具
- **优化**：并发执行独立工具，聚合结果
- **收益**：多工具调用耗时降低

#### 工具结果缓存
- **当前**：每次重新执行
- **优化**：对幂等工具（如 fs.read）按参数哈希缓存结果（TTL 可配）
- **收益**：重复调用加速

### 4. sys box

#### 采样与聚合
- **当前**：全量记录所有事件
- **优化**：可配置采样率（如 0.1 仅记录 10%）、按组件/级别过滤
- **收益**：高频事件下降低 I/O 与存储

#### 时序存储优化
- **当前**：SQLite 单表追加
- **优化**：分表/分区（按日期）、异步写入队列、定期归档
- **收益**：查询性能稳定，避免单表过大

### 5. 函数式 Shell

#### 懒求值
- **当前**：立即求值
- **优化**：引入惰性求值（Thunk），避免不必要的文件读取
- **收益**：管道中短路优化（如 `files(...) | take(10)`）

#### 并行 map
- **当前**：串行遍历
- **优化**：`par_map` 并行应用函数（线程池）
- **收益**：大列表处理加速

## 内存优化

### 1. 模型加载
- **mmap**：默认已启用，避免不必要的 `use_mlock`
- **量化**：生产环境优先 Q4_K_M（体积/质量平衡）

### 2. 会话状态
- **LRU 淘汰**：内存会话数超过阈值时淘汰最久未用
- **持久化重载**：从 SQLite 按需加载历史，而非全驻留内存

### 3. 日志与事件
- **环形缓冲**：内存 sysbox 事件限制最近 N 条
- **异步写入**：事件先写内存队列，后台线程批量落盘

## 稳定性优化

### 1. 错误恢复
- 推理失败自动重试（带指数退避）
- 上下文损坏时自动重建
- 工具超时后优雅降级

### 2. 资源限制
- 单会话最大消息数（防内存泄漏）
- 工具最大并发数（防 fork 炸弹）
- SQLite 连接池与事务批量提交

### 3. 监控与告警
- 推理延迟超过阈值记录 warn
- 工具失败率超过阈值触发断路器
- 内存/磁盘使用接近上限预警

## 代码质量

### 1. 测试覆盖
- 为每个模块编写单元测试（GoogleTest）
- 端到端回放测试（录制 REPL 会话）
- 基准回归测试（CI 中运行）

### 2. 静态分析
- 启用 clang-tidy、cppcheck
- 地址/线程/UB sanitizers（-fsanitize=address,thread,undefined）
- 代码覆盖率报告（gcov/lcov）

### 3. 文档同步
- API 变更时同步更新 docs/
- 配置项变更更新 config.md
- 新工具/函数更新 usage.md

## 扩展性优化

### 1. 插件系统
- 动态加载 .so/.dll 工具插件
- Provider 插件化（注册-发现机制）
- 观测器插件（自定义 sys box sink）

### 2. 配置热重载
- 监听配置文件变更（inotify/FSEvents）
- 无需重启更新白名单、超时、路由规则

### 3. 多语言绑定
- Python/Node.js FFI（通过 C ABI）
- gRPC/REST API 服务模式

## 安全加固

### 1. 沙箱强化
- chroot/namespace 隔离（Linux）
- SELinux/AppArmor 策略
- 命令参数转义增强

### 2. 审计与合规
- 操作日志不可篡改（append-only、签名）
- 敏感字段自动脱敏（API Key、路径）
- GDPR/数据留存策略

### 3. 认证与授权
- 多租户会话隔离
- API Key 加密存储（Keyring）
- RBAC 工具权限控制


